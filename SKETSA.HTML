<script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('photo-upload');
        const uploadTextStatus = document.getElementById('upload-text-status');
        const btnProcess = document.getElementById('btn-process');
        const promptInput = document.getElementById('prompt-input');
        
        let selectedFile = null; 

        function getActiveData(group) {
            const activeBtn = document.querySelector(`.selection-grid[data-group="${group}"] .selection-btn.active`);
            return activeBtn ? activeBtn.getAttribute('data-value') : 'N/A';
        }

        function selectOption(selectedButton, groupName) {
            const parent = selectedButton.closest('.selection-grid');
            const buttons = parent.querySelectorAll('.selection-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            selectedButton.classList.add('active');
            
            checkCompleteness();
        }

        function autoFillPrompt() {
            promptInput.value = "Buat sketsa dengan gaya pensil hitam putih, detail rambut dan bayangan yang tajam.";
            promptInput.dispatchEvent(new Event('input')); 
        }

        dropzone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                selectedFile = this.files[0];
                const fileName = selectedFile.name;
                
                if (selectedFile.size > 5 * 1024 * 1024) { // 5MB limit
                     alert('Peringatan: Ukuran file lebih dari 5MB. Proses Base64 mungkin gagal atau lambat. Gunakan file yang lebih kecil.');
                }
                
                uploadTextStatus.textContent = `File Terpilih: ${fileName}`;
                dropzone.style.borderColor = 'var(--neon-accent)';
                dropzone.style.background = 'rgba(168, 85, 247, 0.1)';
                dropzone.querySelector('.upload-icon svg').style.color = 'var(--neon-accent)';
                
                checkCompleteness();
            }
        });
        
        function checkCompleteness() {
            const isGoalSelected = getActiveData('goal') !== 'N/A';
            const isRatioSelected = getActiveData('ratio') !== 'N/A';
            
            if (selectedFile && isGoalSelected && isRatioSelected) {
                btnProcess.disabled = false;
            } else {
                btnProcess.disabled = true;
            }
        }

        // --- FUNGSI BASE64 DAN ORDER BARU ---
        function processFileAndOrder() {
            if (!selectedFile) return;

            const reader = new FileReader();

            reader.onloadstart = () => {
                btnProcess.textContent = "Processing File...";
                btnProcess.disabled = true;
            };

            reader.onload = function(event) {
                const base64String = event.target.result;
                
                // Ambil data rincian
                const goal = getActiveData('goal');
                const ratio = getActiveData('ratio');
                const prompt = promptInput.value;

                const orderData = {
                    layanan: 'Smart Sketch',
                    goal: goal,
                    ratio: ratio,
                    prompt: prompt,
                    file_base64: base64String,
                    file_name: selectedFile.name,
                    file_type: selectedFile.type
                };
                
                localStorage.setItem('pendingOrderDetails', JSON.stringify(orderData));
                window.location.href = 'DISCLAIMER edit.html';
            };

            reader.onerror = (error) => {
                alert('Gagal membaca file. Ukuran file mungkin terlalu besar atau format tidak didukung. Coba gambar lain.');
                btnProcess.textContent = "Order Smart Sketch";
                btnProcess.disabled = false;
            };

            reader.readAsDataURL(selectedFile);
        }

        btnProcess.addEventListener('click', processFileAndOrder);
        // --- AKHIR FUNGSI BASE64 DAN ORDER BARU ---
        
        document.addEventListener('DOMContentLoaded', checkCompleteness);
        
        // Drag and drop listeners
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            let dt = e.dataTransfer;
            fileInput.files = dt.files;
            fileInput.dispatchEvent(new Event('change')); 
        }
        dropzone.addEventListener('drop', handleDrop, false);

        promptInput.addEventListener('input', checkCompleteness);

    </script>
